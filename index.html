<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Airtable/DataTables Test</title>
    <!-- DEPENDENCIES -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <!-- <script src="node_modules/airtable/build/airtable.browser.js"></script> -->
    <script src="http://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript">
        var cleanMenuData = [];
        myPlate = [];
        var table = [];
        // Build clean json object w/ menu items
        function MenuItem(item) {
            this.item = [];
            this.item.push(item["name"]);
            this.item.push(item["ingredients"]);
            this.location = item["location"];
            this.serving = item["servingsize"];
            this.calories = item["calories"];
            this.fat = item["totalfat"];
            this.protein = item["protein"];
            this.vegan = item["vegan"];
        }

        // PLATE FUNCTIONS

        function addToPlate(item) {
            myPlate.push(item);
            updateNutrition(myPlate);
            drawPlate(myPlate);
        }

        function updateNutrition(plate) {
            var cals = fat = chol = fiber = sod = carb = protein = sugar = 0;
            for (const key of Object.keys(plate)) {
                cals += plate[key]["calories"];
                fat += plate[key]["fat"];
                protein += plate[key]["protein"];
            } 
            $("#calories").text("Calories: " + cals);
            $("#fat").text("Fat: " + fat);
            $("#protein").text("Protein: " + protein);
        }

        function drawPlate(plate) {
            $("#plate-list").html('');
            for (const key of Object.keys(plate)) {
                var li = document.createElement("li");
                li.textContent = plate[key]["item"][0] + " from " + plate[key]["location"];
                li.className = "plateItem";
                var del = document.createElement("a");
                del.textContent = " Delete "
                del.setAttribute("href", "#delete");
                del.setAttribute("class", "del");
                $("#plate-list").append(li);
                $("#plate-list").append(del);
            }
        }

        // CLICK HANDLERS FOR MENU AND PLATE ITEMS
        $(document).ready(function() {

            // ADD TO PLATE HANDLER
            $("#nutrition tbody").on('click', 'tr', function () {
                var rowData = $("#nutrition").DataTable().row(this).data();
                addToPlate(rowData);
            });

            // REMOVE FROM PLATE HANDLER
            $("#plate-list").on('click', 'a', function () {
                for (const key of Object.keys(myPlate)) {
                    // THIS LOOKS WEIRD BECAUSE WE DELETE ITEMS BASED ON WHETHER OR NOT THEIR TITLE IN THE PLATE LIST MATCH THE ITEM THAT WAS CLICKED - SO WE HAVE TO TEST FOR "XYZ FROM ABC" INSTEAD OF JUST "XYZ"
                    if (myPlate[key]["item"][0] + " from " + myPlate[key]["location"] == this.previousSibling.textContent) {
                        myPlate.splice(key, 1);
                        break;
                    }
                }
                drawPlate(myPlate);
                updateNutrition(myPlate);
            }); 

        });

        // BUILD TABLE FUNCTION
        function buildTable() {
            table = $('#nutrition').DataTable({
                data: cleanMenuData,
                columns: [
                    { data: 'item.0', },
                    { data: 'item.1' },
                    { data: 'location' },
                    { data: 'serving' },
                    { data: 'calories' },
                    { data: 'fat' },
                    { data: 'protein' },
                    { data: 'vegan' }
                ]
            }); 
        }

        var resJSON = []
        var offset = "";

        function fetchURL(url, offset) {
            return new Promise((resolve, reject) => {
                var reqURL = url + "&offset=" + offset
                fetch(reqURL).then(function (res) {
                    return res.json();
                }).then(function (json) {
                    offset = json.offset;
                    resJSON = resJSON.concat(json.records);
                }).then(function () {
                    if (offset) {
                        fetchURL(url, offset);
                    } else {
                        resolve();
                        populateMenu(resJSON);
                    }
                });
                console.log(resJSON);
            })
        }

        fetchURL('https://api.airtable.com/v0/appWiY0eBD54EP3TA/Imported%20table?api_key=keyVUAXlzMFjFfXSE', "");

        function populateMenu(json) {
            console.log(json.length);
            for (const key of Object.keys(json)) {
                // ADD ICONS TO VEGAN/VEG FIELDS
                if (json[key]["fields"]["vegan"] == "1") {
                    json[key]["fields"]["vegan"] = "<img src=https://via.placeholder.com/20 />";
                } else {
                    json[key]["fields"]["vegan"] = "";
                }
                // CREATE NEW MENUITEM OBJECT FROM AIRTABLE DATA
                let i = new MenuItem(json[key]["fields"]);
                cleanMenuData.push(i);
            }
            buildTable();
        }


        // fetch('https://api.airtable.com/v0/appWiY0eBD54EP3TA/Imported%20table?api_key=keyVUAXlzMFjFfXSE')
        //     .then(function (response) {
        //         return response.json();
        //     })
        //     .then(function (json1) {
        //         console.log(json1);
        //         offset = json1.offset;
        //         json1 = json1.records
        //         offsetURL1 = 'https://api.airtable.com/v0/appWiY0eBD54EP3TA/Imported%20table?api_key=keyVUAXlzMFjFfXSE';
        //         // DUMB WAY OF HANDLING OFFSETS/PAGINATION SINCE AIRTABLE ONLY RETURNS 100 RESULTS AT A TIME - FIX THIS
        //         fetch(offsetURL1, {
        //             'offset': offset
        //         })
        //             .then(function (response) {
        //                 return response.json();
        //             })
        //             .then(function (json) {
        //                 console.log(json);
        //                 json = json.records
        //                 json = json1.concat(json);
        //                 for (const key of Object.keys(json)) {
        //                     // ADD ICONS TO VEGAN/VEG FIELDS
        //                     if (json[key]["fields"]["vegan"] == "1") {
        //                         json[key]["fields"]["vegan"] = "<img src=https://via.placeholder.com/20 />";
        //                     } else {
        //                         json[key]["fields"]["vegan"] = "";
        //                     }
        //                     // CREATE NEW MENUITEM OBJECT FROM AIRTABLE DATA
        //                     let i = new MenuItem(json[key]["fields"]);
        //                     cleanMenuData.push(i);
        //                 }
        //             // BUILD THE DATATABLE
        //             }).then(function () {
        //                 buildTable();
        //             })
        //     });


    </script>
</head>
<body>
    <h1>Test</h1>

    <!-- PLATE NUTRITION -->
    <div id="plate">
        <li><span id="calories"></span></li>
        <li><span id="fat"></span></li>
        <li><span id="protein"></span></li>
    </div>

    <div class="plate-list">
        <ul id="plate-list">

        </ul>
    </div>
    

    <table id="nutrition" class="display">
        <thead>
            <tr>
                <th>Menu Item</th>
                <th>Ingredients</th>
                <th>Restaurant</th>
                <th>Serving Size</th>
                <th>Calories</th>
                <th>Fat</th>
                <th>Protein</th>
                <th>Vegan?</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>
</html>